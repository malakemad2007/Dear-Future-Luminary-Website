<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In | Dear Future Luminary</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --primary-bg: #ffffff;
      --secondary-bg: #f8f9fa;
      --text-color: #2c3e50;
      --accent-color: #6a3093;
      --accent-light: #a044ff;
      --highlight: #f1c40f;
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --nav-bg: #ffffff;
      --footer-bg: #f8f9fa;
      --transition-speed: 0.3s;
    }

    [data-theme="elegant"] {
      --primary-bg: #ffffff;
      --secondary-bg: #f5f5f5;
      --text-color: #2c3e50;
      --accent-color: #2e2e2e;
      --accent-light: #4a4a4a;
      --highlight: #d4a017;
    }

    [data-theme="cosmic"] {
      --primary-bg: #ffffff;
      --secondary-bg: #f0f4f8;
      --text-color: #2c3e50;
      --accent-color: #1e3a8a;
      --accent-light: #3b82f6;
      --highlight: #10b981;
    }

    [data-theme="bright"] {
      --primary-bg: #ffffff;
      --secondary-bg: #fef3e7;
      --text-color: #2c3e50;
      --accent-color: #e11d48;
      --accent-light: #fb7185;
      --highlight: #f59e0b;
    }

    [data-theme="vibrant"] {
      --primary-bg: #ffffff;
      --secondary-bg: #f4eaff;
      --text-color: #2c3e50;
      --accent-color: #7c3aed;
      --accent-light: #a78bfa;
      --highlight: #ec4899;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all var(--transition-speed);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
      overflow-x: hidden;
    }

    h1, h2, .logo {
      font-family: 'Playfair Display', serif;
    }

    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: var(--nav-bg);
      box-shadow: 0 2px 5px var(--card-shadow);
      z-index: 1000;
      padding: 1rem 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.8rem;
      color: var(--accent-color);
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .logo:hover {
      color: var(--accent-light);
    }

    .nav-menu {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-toggle {
      background: none;
      border: none;
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .dropdown-toggle:hover {
      background: var(--accent-color);
      color: #ffffff;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--nav-bg);
      border-radius: 5px;
      box-shadow: 0 5px 15px var(--card-shadow);
      flex-direction: column;
      padding: 0.5rem;
      min-width: 180px;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
    }

    .dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu a,
    .dropdown-menu .theme-option {
      text-decoration: none;
      color: var(--text-color);
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .dropdown-menu a:hover,
    .dropdown-menu .theme-option:hover {
      background: var(--accent-light);
      color: #ffffff;
    }

    .theme-option.active {
      background: var(--accent-color);
      color: #ffffff;
      position: relative;
    }

    .theme-option.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 2px solid var(--accent-color);
      border-radius: 5px;
    }

    .auth-button {
      padding: 0.5rem 1rem;
      background: var(--accent-color);
      color: #ffffff;
      border: none;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .auth-button:hover {
      background: var(--accent-light);
    }

    .auth-section {
      margin-top: 80px;
      padding: 4rem 5%;
      background: linear-gradient(135deg, var(--secondary-bg), var(--primary-bg));
      text-align: center;
      min-height: calc(100vh - 80px);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .auth-container {
      max-width: 450px;
      width: 100%;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px var(--card-shadow);
      position: relative;
      overflow: hidden;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .auth-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
      background: var(--secondary-bg);
      border-radius: 8px;
      padding: 0.3rem;
    }

    .tab {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      flex: 1;
      text-align: center;
    }

    .tab.active {
      background: var(--accent-color);
      color: #ffffff;
    }

    .tab:hover {
      background: var(--accent-light);
      color: #ffffff;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .input-group {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-group i {
      position: absolute;
      left: 12px;
      color: var(--accent-color);
      font-size: 1.2rem;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }

    .input-group .status-icon {
      position: absolute;
      right: 12px;
      font-size: 1rem;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }

    .input-group.valid .status-icon.fa-check {
      display: block;
      color: #10b981;
    }

    .input-group.invalid .status-icon.fa-times {
      display: block;
      color: #e11d48;
    }

    .auth-form input {
      padding: 0.9rem 0.9rem 0.9rem 3rem;
      border: 1px solid var(--card-shadow);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--primary-bg);
      color: var(--text-color);
      width: 100%;
      box-shadow: inset 0 2px 4px var(--card-shadow);
    }

    .auth-form input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-light);
    }

    .auth-form .file-input-container {
      border: 2px dashed var(--accent-color);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      background: var(--secondary-bg);
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .auth-form .file-input-container:hover {
      background: var(--accent-light);
      border-color: var(--accent-light);
      color: #ffffff;
    }

    .auth-form .file-input-container.dragover {
      background: var(--accent-color);
      color: #ffffff;
    }

    .auth-form .file-input {
      display: none;
    }

    .auth-form .file-preview {
      margin-top: 0.5rem;
      max-width: 100%;
      max-height: 100px;
      border-radius: 8px;
      display: none;
    }

    .auth-form .file-preview.visible {
      display: block;
    }

    .auth-form .show-password {
      position: absolute;
      right: 40px;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 0.9rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .auth-form button {
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-color), var(--accent-light));
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .auth-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--card-shadow);
    }

    .auth-form button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s ease, height 0.4s ease;
    }

    .auth-form button:active::after {
      width: 200px;
      height: 200px;
    }

    .error-message {
      color: #e11d48;
      font-size: 0.8rem;
      margin-top: 0.2rem;
      text-align: left;
      display: none;
    }

    .error-message.visible {
      display: block;
    }

    .optional-text {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
      text-align: left;
    }

    .footer {
      background-color: var(--footer-bg);
      color: var(--text-color);
      text-align: center;
      padding: 2rem 0;
      font-size: 0.9rem;
      margin-top: auto;
    }

    @media (max-width: 480px) {
      .auth-container {
        padding: 1.5rem;
      }

      .auth-tabs {
        flex-direction: column;
      }

      .tab {
        font-size: 0.9rem;
        padding: 0.6rem;
      }

      .auth-form input, .auth-form button {
        font-size: 0.9rem;
        padding: 0.8rem;
      }

      .input-group i, .auth-form .show-password {
        font-size: 1rem;
      }

      .auth-form .file-input-container {
        padding: 0.8rem;
      }

      .nav-menu {
        gap: 0.5rem;
      }

      .dropdown-toggle, .auth-button {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }

      .dropdown-menu {
        min-width: 150px;
      }

      .dropdown-menu a, .dropdown-menu .theme-option {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo" onclick="window.location.href='index.html'">Dear Future Luminary</div>
    <div class="nav-menu">
      <div class="dropdown">
        <button class="dropdown-toggle"><i class="fas fa-bars"></i> Menu</button>
        <div class="dropdown-menu">
          <a href="index.html"><i class="fas fa-home"></i> Home</a>
          <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          <a href="teams.html"><i class="fas fa-users"></i> Teams</a>
          <a href="programs.html"><i class="fas fa-cogs"></i> Programs</a>
          <a href="radar.html"><i class="fas fa-bullseye"></i> Opportunity Radar</a>
          <a href="upgrade.html"><i class="fas fa-arrow-up"></i> Resources</a>
          <a href="my-story.html"><i class="fas fa-star"></i> My Story</a>
          <a href="about开门.html"><i class="fas fa-info-circle"></i> About Us</a>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropdown-toggle"><i class="fas fa-palette"></i> Themes</button>
        <div class="dropdown-menu">
          <div class="theme-option" data-theme="default"><i class="fas fa-sun"></i> Default</div>
          <div class="theme-option" data-theme="elegant"><i class="fas fa-gem"></i> Elegant</div>
          <div class="theme-option" data-theme="cosmic"><i class="fas fa-star"></i> Cosmic</div>
          <div class="theme-option" data-theme="bright"><i class="fas fa-lightbulb"></i> Bright</div>
          <div class="theme-option" data-theme="vibrant"><i class="fas fa-bolt"></i> Vibrant</div>
        </div>
      </div>
      <button class="auth-button" id="authButton"><i class="fas fa-user"></i> Sign In</button>
      <button class="auth-button" id="dashboardButton" style="display: none;"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
      <button class="auth-button" id="logoutButton" style="display: none;"><i class="fas fa-sign-out-alt"></i> Log Out</button>
    </div>
  </nav>

  <!-- Auth Section -->
  <section class="auth-section">
    <div class="auth-container">
      <div class="auth-tabs">
        <div class="tab active" data-tab="signin">Sign In</div>
        <div class="tab" data-tab="signup">Sign Up</div>
      </div>
      <form class="auth-form" id="authForm">
        <div class="input-group" id="usernameGroup" style="display: none;">
          <i class="fas fa-user"></i>
          <input type="text" id="username" placeholder="Username (optional)">
          <i class="fas fa-check status-icon"></i>
          <i class="fas fa-times status-icon"></i>
          <div class="error-message" id="usernameError"></div>
        </div>
        <div class="input-group">
          <i class="fas fa-envelope"></i>
          <input type="email" id="email" placeholder="Email" required>
          <i class="fas fa-check status-icon"></i>
          <i class="fas fa-times status-icon"></i>
          <div class="error-message" id="emailError"></div>
        </div>
        <div class="input-group">
          <i class="fas fa-lock"></i>
          <input type="password" id="password" placeholder="Password (min 8 characters)" required>
          <i class="fas fa-check status-icon"></i>
          <i class="fas fa-times status-icon"></i>
          <span class="show-password" id="showPassword">Show</span>
          <div class="error-message" id="passwordError"></div>
        </div>
        <div class="input-group" id="confirmPasswordGroup" style="display: none;">
          <i class="fas fa-lock"></i>
          <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
          <i class="fas fa-check status-icon"></i>
          <i class="fas fa-times status-icon"></i>
          <span class="show-password" id="showConfirmPassword">Show</span>
          <div class="error-message" id="confirmPasswordError"></div>
        </div>
        <div class="input-group" id="profilePictureGroup" style="display: none;">
          <div class="file-input-container" id="fileInputContainer">
            <p>Drag & Drop Profile Picture or Click to Upload (JPEG/PNG, max 2MB)</p>
            <input type="file" id="profilePicture" class="file-input" accept="image/jpeg,image/png">
          </div>
          <img id="filePreview" class="file-preview" alt="Profile Picture Preview">
          <div class="optional-text">Profile picture is optional</div>
          <div class="error-message" id="profilePictureError"></div>
        </div>
        <button type="submit" id="authSubmit">Sign In</button>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <p>© 2025 Dear Future Luminary. All rights reserved.</p>
  </footer>

  <script>
    // Supabase Configuration
    const supabaseUrl = 'https://jevybfnbqyrichojeyqf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpldnliZm5icXlyaWNob2pleXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MzAxMjYsImV4cCI6MjA2MTQwNjEyNn0.DLilVzucWrjo-cPmDBrs7Srmi31HAO1ShJ1RKw6tu8A';
    let supabase;

    // Check if Supabase library is loaded
    if (typeof supabase === 'undefined') {
      console.error('Supabase library not loaded. Please ensure the Supabase script is loaded correctly.');
      document.getElementById('emailError').textContent = 'Failed to load Supabase library. Please check your internet connection and try again.';
      document.getElementById('emailError').classList.add('visible');
    } else {
      // Initialize Supabase client
      try {
        supabase = supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase client initialized successfully:', supabase);
      } catch (error) {
        console.error('Error initializing Supabase:', error.message);
        document.getElementById('emailError').textContent = 'Failed to connect to the server: ' + error.message;
        document.getElementById('emailError').classList.add('visible');
      }
    }

    // Theme Switching
    const themeOptions = document.querySelectorAll('.theme-option');
    const savedTheme = localStorage.getItem('theme') || 'default';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeOptions.forEach(option => {
      if (option.dataset.theme === savedTheme) {
        option.classList.add('active');
      }
    });

    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.dataset.theme;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
      });
    });

    // Form Elements
    const authForm = document.getElementById('authForm');
    const authSubmit = document.getElementById('authSubmit');
    const usernameGroup = document.getElementById('usernameGroup');
    const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
    const profilePictureGroup = document.getElementById('profilePictureGroup');
    const tabs = document.querySelectorAll('.tab');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const usernameInput = document.getElementById('username');
    const profilePictureInput = document.getElementById('profilePicture');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const filePreview = document.getElementById('filePreview');
    const showPassword = document.getElementById('showPassword');
    const showConfirmPassword = document.getElementById('showConfirmPassword');
    const authButton = document.getElementById('authButton');
    const dashboardButton = document.getElementById('dashboardButton');
    const logoutButton = document.getElementById('logoutButton');
    let isSignIn = true;

    // Check if user is logged in
    const user = JSON.parse(localStorage.getItem('user'));
    if (user) {
      authButton.style.display = 'none';
      dashboardButton.style.display = 'inline-flex';
      logoutButton.style.display = 'inline-flex';
    }

    // Tab Switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        isSignIn = tab.dataset.tab === 'signin';
        authSubmit.textContent = isSignIn ? 'Sign In' : 'Sign Up';
        usernameGroup.style.display = isSignIn ? 'none' : 'block';
        confirmPasswordGroup.style.display = isSignIn ? 'none' : 'block';
        profilePictureGroup.style.display = isSignIn ? 'none' : 'block';
        clearErrors();
        validateInputs();
      });
    });

    // Show/Hide Password
    showPassword.addEventListener('click', () => {
      const type = passwordInput.type === 'password' ? 'text' : 'password';
      passwordInput.type = type;
      showPassword.textContent = type === 'password' ? 'Show' : 'Hide';
    });

    showConfirmPassword.addEventListener('click', () => {
      const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
      confirmPasswordInput.type = type;
      showConfirmPassword.textContent = type === 'password' ? 'Show' : 'Hide';
    });

    // Drag and Drop for Profile Picture
    fileInputContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileInputContainer.classList.add('dragover');
    });

    fileInputContainer.addEventListener('dragleave', () => {
      fileInputContainer.classList.remove('dragover');
    });

    fileInputContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInputContainer.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        profilePictureInput.files = e.dataTransfer.files;
        previewImage(file);
      }
    });

    fileInputContainer.addEventListener('click', () => {
      profilePictureInput.click();
    });

    profilePictureInput.addEventListener('change', () => {
      const file = profilePictureInput.files[0];
      if (file) {
        previewImage(file);
      }
    });

    function previewImage(file) {
      const reader = new FileReader();
      reader.onload = () => {
        filePreview.src = reader.result;
        filePreview.classList.add('visible');
      };
      reader.readAsDataURL(file);
    }

    // Real-time Validation
    function validateInputs() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
      const username = usernameInput ? usernameInput.value.trim() : '';

      const emailGroup = emailInput.parentElement;
      const passwordGroup = passwordInput.parentElement;
      const confirmPasswordGroup = confirmPasswordInput ? confirmPasswordInput.parentElement : null;
      const usernameGroup = usernameInput ? usernameInput.parentElement : null;

      // Email Validation
      if (email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        emailGroup.classList.add('valid');
        emailGroup.classList.remove('invalid');
        document.getElementById('emailError').classList.remove('visible');
      } else if (email) {
        emailGroup.classList.add('invalid');
        emailGroup.classList.remove('valid');
        document.getElementById('emailError').textContent = 'Please enter a valid email.';
        document.getElementById('emailError').classList.add('visible');
      } else {
        emailGroup.classList.remove('valid', 'invalid');
        document.getElementById('emailError').classList.remove('visible');
      }

      // Password Validation
      const passwordRegex = /^(?=.*[0-9]).{8,}$/;
      if (password && passwordRegex.test(password)) {
        passwordGroup.classList.add('valid');
        passwordGroup.classList.remove('invalid');
        document.getElementById('passwordError').classList.remove('visible');
      } else if (password) {
        passwordGroup.classList.add('invalid');
        passwordGroup.classList.remove('valid');
        document.getElementById('passwordError').textContent = 'Password must be at least 8 characters and include a number.';
        document.getElementById('passwordError').classList.add('visible');
      } else {
        passwordGroup.classList.remove('valid', 'invalid');
        document.getElementById('passwordError').classList.remove('visible');
      }

      // Confirm Password Validation
      if (confirmPasswordGroup) {
        if (confirmPassword && confirmPassword === password && passwordRegex.test(password)) {
          confirmPasswordGroup.classList.add('valid');
          confirmPasswordGroup.classList.remove('invalid');
          document.getElementById('confirmPasswordError').classList.remove('visible');
        } else if (confirmPassword) {
          confirmPasswordGroup.classList.add('invalid');
          confirmPasswordGroup.classList.remove('valid');
          document.getElementById('confirmPasswordError').textContent = 'Passwords do not match.';
          document.getElementById('confirmPasswordError').classList.add('visible');
        } else {
          confirmPasswordGroup.classList.remove('valid', 'invalid');
          document.getElementById('confirmPasswordError').classList.remove('visible');
        }
      }

      // Username Validation
      if (usernameGroup) {
        if (username && username.length <= 20) {
          usernameGroup.classList.add('valid');
          usernameGroup.classList.remove('invalid');
          document.getElementById('usernameError').classList.remove('visible');
        } else if (username) {
          usernameGroup.classList.add('invalid');
          usernameGroup.classList.remove('valid');
          document.getElementById('usernameError').textContent = 'Username must be less than 20 characters.';
          document.getElementById('usernameError').classList.add('visible');
        } else {
          usernameGroup.classList.remove('valid', 'invalid');
          document.getElementById('usernameError').classList.remove('visible');
        }
      }
    }

    emailInput.addEventListener('input', validateInputs);
    passwordInput.addEventListener('input', validateInputs);
    if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', validateInputs);
    if (usernameInput) usernameInput.addEventListener('input', validateInputs);

    // Clear error messages
    function clearErrors() {
      ['emailError', 'passwordError', 'usernameError', 'confirmPasswordError', 'profilePictureError'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = '';
          el.classList.remove('visible');
        }
      });
      document.querySelectorAll('.input-group').forEach(group => {
        group.classList.remove('valid', 'invalid');
      });
    }

    // Validate file (image only, max  2MB)
    function validateFile(file) {
      if (!file) return null;
      const allowedTypes = ['image/jpeg', 'image/png'];
      const maxSize = 2 * 1024 * 1024; // 2MB
      if (!allowedTypes.includes(file.type)) {
        return 'Please upload a JPEG or PNG image.';
      }
      if (file.size > maxSize) {
        return 'Image size must be less than 2MB.';
      }
      return null;
    }

    // Handle form submission
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
      const username = usernameInput ? usernameInput.value.trim() : '';
      const profilePicture = profilePictureInput.files[0];

      clearErrors();
      const errors = {};

      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errors.email = 'Please enter a valid email.';
      }
      if (!password || !/^(?=.*[0-9]).{8,}$/.test(password)) {
        errors.password = 'Password must be at least 8 characters and include a number.';
      }
      if (!isSignIn && confirmPassword !== password) {
        errors.confirmPassword = 'Passwords do not match.';
      }
      if (username && username.length > 20) {
        errors.username = 'Username must be less than 20 characters.';
      }
      if (profilePicture) {
        const fileError = validateFile(profilePicture);
        if (fileError) {
          errors.profilePicture = fileError;
        }
      }

      if (Object.keys(errors).length > 0) {
        Object.keys(errors).forEach(key => {
          const el = document.getElementById(`${key}Error`);
          if (el) {
            el.textContent = errors[key];
            el.classList.add('visible');
          }
        });
        return;
      }

      try {
        if (!supabase) {
          throw new Error('Server connection not initialized. Supabase client is not available.');
        }

        if (isSignIn) {
          // Sign In
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw new Error('Invalid email or password: ' + error.message);
          localStorage.setItem('user', JSON.stringify(data.user));
          authButton.style.display = 'none';
          dashboardButton.style.display = 'inline-flex';
          logoutButton.style.display = 'inline-flex';
          window.location.href = 'dashboard.html';
        } else {
          // Sign Up
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) {
            throw new Error(error.message.includes('User already registered') ? 'This email is already registered.' : 'Sign up failed: ' + error.message);
          }

          let profilePictureUrl = null;
          if (profilePicture) {
            const fileExt = profilePicture.name.split('.').pop();
            const fileName = `${data.user.id}.${fileExt}`;
            const { error: uploadError } = await supabase.storage
              .from('profile_pictures')
              .upload(fileName, profilePicture, { upsert: true });
            if (uploadError) throw new Error('Failed to upload profile picture: ' + uploadError.message);

            const { data: urlData } = supabase.storage
              .from('profile_pictures')
              .getPublicUrl(fileName);
            profilePictureUrl = urlData.publicUrl;
          }

          const { error: dbError } = await supabase
            .from('users')
            .upsert({
              id: data.user.id,
              email: data.user.email,
              username: username || null,
              profile_picture: profilePictureUrl
            });
          if (dbError) throw new Error('Failed to save user data: ' + dbError.message);

          localStorage.setItem('user', JSON.stringify({ ...data.user, username, profile_picture: profilePictureUrl }));
          authButton.style.display = 'none';
          dashboardButton.style.display = 'inline-flex';
          logoutButton.style.display = 'inline-flex';
          window.location.href = 'dashboard.html';
        }
      } catch (error) {
        console.error('Authentication error:', error.message);
        document.getElementById('emailError').textContent = error.message;
        document.getElementById('emailError').classList.add('visible');
      }
    });

    // Logout
    logoutButton.addEventListener('click', async () => {
      try {
        if (!supabase) {
          throw new Error('Server connection not initialized. Supabase client is not available.');
        }
        await supabase.auth.signOut();
        localStorage.removeItem('user');
        authButton.style.display = 'inline-flex';
        dashboardButton.style.display = 'none';
        logoutButton.style.display = 'none';
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error.message);
        document.getElementById('emailError').textContent = 'Failed to log out: ' + error.message;
        document.getElementById('emailError').classList.add('visible');
      }
    });

    // Initialize validation
    validateInputs();
  </script>
</body>
</html>